SET SERVEROUTPUT ON;

CREATE OR REPLACE FUNCTION CHECK_VETERINARIAN_ID_FUNC(IN_VETERINARIAN_ID IN VARCHAR2)
RETURN BOOLEAN IS

V_NUMBER NUMBER := 0;
BEGIN

 SELECT COUNT(VETERINARIAN_ID) INTO V_NUMBER
 FROM veterinarian
 WHERE VETERINARIAN_ID = IN_VETERINARIAN_ID;

 IF(V_NUMBER<>0) THEN
    RETURN TRUE;

 ELSE
    RETURN FALSE;
 END IF;

 EXCEPTION
    WHEN OTHERS THEN
       RETURN FALSE;
END;
/

CREATE OR REPLACE PROCEDURE LIST_OF_PET_PROC(IN_VETERINARIAN_ID IN VARCHAR2) AS

 V_PET_ID PET.PET_ID%TYPE;
 V_PET_NAME PET.PET_NAME%TYPE;
 V_PET_SPECIES PET.PET_SPECIES%TYPE;
 V_TOTAL_PETNO NUMBER;
 V_NUM NUMBER := 1;

 CURSOR PET_LIST_CURSOR IS
 SELECT V.VETERINARIAN_ID, P.PET_ID, P.PET_NAME, P.PET_SPECIES, COUNT(P.PET_ID) AS "Frequency"
 FROM appointment_details AD, appointment A, treatment T, veterinarian V, pet P
 WHERE AD.treatment_id = T.treatment_id AND
	AD.appointment_id = A.appointment_id AND
      V.veterinarian_id = AD.veterinarian_id AND
      A.pet_id = P.pet_id
 GROUP BY V.VETERINARIAN_ID, P.PET_ID, P.PET_NAME, P.PET_SPECIES
 ORDER BY V.VETERINARIAN_ID;

 PET_LIST_REC PET_LIST_CURSOR%ROWTYPE;

 DATA_NOTFOUND EXCEPTION;
 PRAGMA exception_init(DATA_NOTFOUND, -20123);

BEGIN
 IF (CHECK_VETERINARIAN_ID_FUNC(IN_VETERINARIAN_ID) = FALSE) THEN
    RAISE_APPLICATION_ERROR(-20123, 'Veterinarian not found!');
 END IF;

 DBMS_OUTPUT.PUT_LINE(CHR(10));
 DBMS_OUTPUT.PUT_LINE('On-Demand Report - List of Pets Visit Frequency for Each Veterinarian');
 DBMS_OUTPUT.PUT_LINE(LPAD('Report generated on : ', 100, ' ') || TO_CHAR(CURRENT_DATE, 'DD-MMYYYY HH:MI:SS') || ' by ' || USER);

 DBMS_OUTPUT.PUT_LINE(CHR(10)||
 			 RPAD('Veterinarian',15, ' ') || ' ' ||
 			 RPAD('Pet ID',10, ' ') || ' ' ||
 			 RPAD('Pet Name',31,' ') || ' ' ||
 			 RPAD('Pet Species',28,' ') || ' ' ||
 			 RPAD('Frequency',14,' '));

 DBMS_OUTPUT.PUT_LINE(LPAD('-',118,'-'));

 OPEN PET_LIST_CURSOR;
 LOOP

 FETCH PET_LIST_CURSOR INTO PET_LIST_REC.VETERINARIAN_ID,
 PET_LIST_REC.PET_ID,PET_LIST_REC.PET_NAME,
 PET_LIST_REC.PET_SPECIES, PET_LIST_REC."Frequency";

 IF (PET_LIST_CURSOR%ROWCOUNT = 0) THEN
  DBMS_OUTPUT.PUT_LINE('No pet has been assigned to Veterinarian ' || IN_VETERINARIAN_ID || '.');
 END IF;

 EXIT WHEN PET_LIST_CURSOR%NOTFOUND;

 IF IN_VETERINARIAN_ID = PET_LIST_REC.VETERINARIAN_ID THEN
     DBMS_OUTPUT.PUT_LINE(RPAD(PET_LIST_REC.VETERINARIAN_ID,15,' ')||' '||
 			 RPAD(PET_LIST_REC.PET_ID,10,' ')|| ' '||
 			 RPAD(PET_LIST_REC.PET_NAME,31,' ')|| ' ' ||
 			 RPAD(PET_LIST_REC.PET_SPECIES, 31, ' ') || ' ' ||
 			 RPAD(PET_LIST_REC."Frequency",15, ' '));
 END IF;

 END LOOP;

 CLOSE PET_LIST_CURSOR;

 DBMS_OUTPUT.PUT_LINE(LPAD('=',118,'='));
 DBMS_OUTPUT.PUT_LINE(CHR(10)||LPAD('-END OF REPORT-',62,' '));

 EXCEPTION
   WHEN DATA_NOTFOUND THEN
   DBMS_OUTPUT.PUT_LINE ('An error was encountered ' || chr(10)|| SQLERRM);
END;
/


/*
EXEC LIST_OF_PET_PROC('V0001');
EXEC LIST_OF_PET_PROC('V0016'); cannot insert
*/
