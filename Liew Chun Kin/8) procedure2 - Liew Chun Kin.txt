SET SERVEROUTPUT ON;
alter SESSION set NLS_DATE_FORMAT = 'DD/MM/YYYY';

DROP SEQUENCE paymentIDSeq;

CREATE SEQUENCE paymentIDSeq
	INCREMENT BY 1
	START WITH 0121
	NOCACHE
	NOCYCLE;

CREATE OR REPLACE PROCEDURE PRC_UPDATE_APPOINTMENT_STATUS (IN_APPOINTMENT_ID IN VARCHAR2, IN_APPOINTMENT_STATUS IN VARCHAR2) AS 

E_INVALID_APPOINTMENT_ID EXCEPTION;
PRAGMA EXCEPTION_INIT(E_INVALID_APPOINTMENT_ID, -20023);

E_INVALID_STATUS EXCEPTION;
PRAGMA EXCEPTION_INIT(E_INVALID_STATUS, -20024);

V_CUST_LNAME CUSTOMER.CUST_LNAME%TYPE;
V_PET_ID PET.PET_ID%TYPE;
V_APPOINTMENT_STATUS APPOINTMENT.APPOINTMENT_STATUS%TYPE;

V_STATUS APPOINTMENT.APPOINTMENT_STATUS%TYPE;

CURSOR APPOINTMENT_CURSOR IS
 SELECT APPOINTMENT_ID
 FROM APPOINTMENT
 WHERE APPOINTMENT_ID = IN_APPOINTMENT_ID;

APPOINTMENT_RECORD APPOINTMENT_CURSOR%ROWTYPE;

   PROCEDURE GET_ID(IN_APPOINTMENT_ID IN VARCHAR2) IS
      BEGIN
          SELECT C.CUST_LNAME, P.PET_ID, A.APPOINTMENT_STATUS INTO V_CUST_LNAME, V_PET_ID, V_APPOINTMENT_STATUS
            FROM CUSTOMER C, PET P, APPOINTMENT A
            WHERE A.APPOINTMENT_ID = IN_APPOINTMENT_ID AND
                  A.PET_ID = P.PET_ID AND
                P.CUST_ID = C.CUST_ID;

         EXCEPTION
             WHEN NO_DATA_FOUND THEN
               RAISE_APPLICATION_ERROR(-20023,'Updated failed : Input appointment ID does not exist.' );
       END;

BEGIN

 GET_ID(IN_APPOINTMENT_ID);

 V_STATUS := IN_APPOINTMENT_STATUS;

 UPDATE APPOINTMENT
 SET APPOINTMENT_STATUS = V_STATUS
 WHERE APPOINTMENT_ID = IN_APPOINTMENT_ID;
 
 IF (IN_APPOINTMENT_STATUS = 'Done') THEN
 insert into payment (payment_id, payment_amount, payment_date, payment_type) values ('P'||lpad(paymentIDSeq.nextval, 4, '0'), 5034.98,(TO_DATE(sysdate, 'DD/MM/YYYY')), 'E-Wallet');

 UPDATE appointment
 SET payment_id = 'P'||lpad(paymentIDSeq.currval, 4, '0')
 WHERE appointment_id = IN_APPOINTMENT_ID;
 END IF;

 DBMS_OUTPUT.PUT_LINE('---------------------------------');
 DBMS_OUTPUT.PUT_LINE('Before update the appointment status');
 DBMS_OUTPUT.PUT_LINE('---------------------------------');
 DBMS_OUTPUT.PUT_LINE('Appointmnet ID : ' || IN_APPOINTMENT_ID);
 DBMS_OUTPUT.PUT_LINE('Appointment Status : ' || V_APPOINTMENT_STATUS);

 DBMS_OUTPUT.PUT_LINE(CHR(10));

 DBMS_OUTPUT.PUT_LINE('Appointment status is updated successfully');

 DBMS_OUTPUT.PUT_LINE('---------------------------------');
 DBMS_OUTPUT.PUT_LINE('After update the appointment status');
 DBMS_OUTPUT.PUT_LINE('---------------------------------');
 DBMS_OUTPUT.PUT_LINE('Appointmnet ID : ' || IN_APPOINTMENT_ID);
 DBMS_OUTPUT.PUT_LINE('Appointment Status : ' || IN_APPOINTMENT_STATUS);

EXCEPTION
   WHEN E_INVALID_APPOINTMENT_ID THEN
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
END;
/

/* 
   SELECT * FROM APPOINTMENT WHERE APPOINTMENT_ID = 'A0121';
   EXEC PRC_UPDATE_APPOINTMENT_STATUS('A0121', 'Done');
   SELECT * FROM APPOINTMENT WHERE APPOINTMENT_ID = 'A0121';
*/