CLEAR COLUMNS
CLEAR BREAKS
CLEAR COMPUTES
TTITLE OFF
REPFOOTER OFF

SET LINESIZE 500
SET PAGESIZE 100

ACCEPT YEAR DATE FORMAT 'YYYY'-
PROMPT 'Enter the year : '

-- VIEW
CREATE OR REPLACE VIEW GET_TREATMENTPRICE_YEAR_MONTH AS
SELECT EXTRACT(YEAR FROM A.appointment_datetime) AS YEAR,
	EXTRACT(MONTH FROM A.appointment_datetime) AS "MONTH NO",
	  TO_CHAR(TO_DATE(EXTRACT(MONTH FROM A.appointment_datetime), 'MM'), 'Month') AS "MONTH NAME" ,
	C.cust_id, C.cust_lname, P.pet_id, P.pet_name,
	(SUM(AD.medicine_qty)* M.medicine_price +
	T.treatment_price) AS "MONTHLY SALES"
FROM appointment_details AD, appointment A, pet P, customer C, medicine M, treatment T
WHERE AD.treatment_id = T.treatment_id AND
	AD.appointment_id = A.appointment_id AND
      AD.medicine_id = M.medicine_id AND
	A.pet_id = P.pet_id AND
	P.cust_id = C.cust_id
GROUP BY EXTRACT(YEAR FROM A.appointment_datetime), EXTRACT(MONTH FROM A.appointment_datetime), C.cust_id, C.cust_lname,
M.medicine_price, T.treatment_price, P.pet_id, P.pet_name
ORDER BY YEAR,"MONTH NO", C.cust_id ;

CREATE OR REPLACE VIEW TOTAL_MONTHLY_SALES AS
SELECT YEAR, "MONTH NAME", SUM("MONTHLY SALES") AS "TOTAL MONTHLY SALES"
FROM GET_TREATMENTPRICE_YEAR_MONTH
WHERE YEAR = &YEAR
GROUP BY YEAR, "MONTH NAME"
ORDER BY "MONTH NAME";

CREATE OR REPLACE VIEW MONTHLY_BEST_AVG_SALES AS
SELECT YEAR, "MONTH NAME", MAX("MONTHLY SALES") AS "BEST SALES", AVG("MONTHLY SALES") AS "AVERAGE SALES"FROM GET_TREATMENTPRICE_YEAR_MONTH
WHERE YEAR = &YEAR
GROUP BY YEAR, "MONTH NAME"
ORDER BY "MONTH NAME";

COLUMN "MONTH NAME" FORMAT A12
COLUMN cust_id FORMAT A11
COLUMN pet_id FORMAT A7
COLUMN pet_name FORMAT A20
COLUMN cust_lname FORMAT A20
COLUMN "BEST SALES" FORMAT 99,999.99
COLUMN "AVERAGE SALES" FORMAT 99,999.99
COLUMN "CONTRIBUTION (%)" FORMAT 999.99

COLUMN cust_id HEADING "CUSTOMER ID"
COLUMN cust_lname HEADING "CUSTOMER NAME"
COLUMN pet_id HEADING "PET ID"
COLUMN pet_name HEADING "PET NAME"
COLUMN "BEST SALES" HEADING "MONTHLY | SALES (RM)"
COLUMN "AVERAGE SALES" HEADING "AVERAGE SALES | AMONG ALL (RM)"

CLEAR SCREEN
TTITLE LEFT 'MONTHLY BEST TREATMENT SALES IN YEAR '&YEAR''SKIP 2

SELECT A."MONTH NAME", A.cust_id, A.cust_lname, A.pet_id, A.pet_name, B."BEST SALES" , B."AVERAGE SALES", ROUND(((A."MONTHLY SALES"/C."TOTAL MONTHLY SALES")*100),2) AS "CONTRIBUTION (%)"
FROM GET_TREATMENTPRICE_YEAR_MONTH A, MONTHLY_BEST_AVG_SALES B, TOTAL_MONTHLY_SALES C
WHERE A."MONTH NAME" = B."MONTH NAME" AND
	B."MONTH NAME" = C."MONTH NAME" AND
	B."BEST SALES" = A."MONTHLY SALES"
ORDER BY A."MONTH NO";
CLEAR COLUMNS
TTITLE OFF

/*
2020
*/